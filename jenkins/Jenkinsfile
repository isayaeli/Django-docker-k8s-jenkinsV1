pipeline {
    agent any
    
    environment {
        DOCKER_REGISTRY = 'your-registry.com'
        IMAGE_NAME = 'django-app'
        KUBECONFIG = credentials('kubeconfig-prod')
        SLACK_CHANNEL = '#deployments'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: "git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()
                    env.IMAGE_TAG = "${env.GIT_COMMIT_SHORT}-${env.BUILD_NUMBER}"
                }
            }
        }
        
        stage('Setup Environment') {
            steps {
                withCredentials([file(credentialsId: 'django-env-prod', variable: 'ENV_FILE')]) {
                    sh 'cp $ENV_FILE .env.production'
                }
            }
        }
        
        stage('Run Tests') {
            steps {
                sh '''
                    docker-compose -f docker-compose.test.yml build
                    docker-compose -f docker-compose.test.yml run --rm web pytest
                    docker-compose -f docker-compose.test.yml run --rm web flake8
                    docker-compose -f docker-compose.test.yml run --rm web black --check .
                '''
            }
            post {
                always {
                    sh 'docker-compose -f docker-compose.test.yml down -v'
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    docker.build(
                        "${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}",
                        "-f docker/django/Dockerfile ."
                    )
                    docker.build(
                        "${DOCKER_REGISTRY}/${IMAGE_NAME}:latest",
                        "-f docker/django/Dockerfile ."
                    )
                }
            }
        }
        
        stage('Push to Registry') {
            steps {
                script {
                    docker.withRegistry("https://${DOCKER_REGISTRY}", 'docker-registry-creds') {
                        docker.image("${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}").push()
                        docker.image("${DOCKER_REGISTRY}/${IMAGE_NAME}:latest").push()
                    }
                }
            }
        }
        
        stage('Security Scan') {
            steps {
                sh """
                    trivy image ${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
                """
            }
        }
        
        stage('Deploy to Kubernetes') {
            steps {
                sh """
                    cd k8s/overlays/production
                    kustomize edit set image ${DOCKER_REGISTRY}/${IMAGE_NAME}=${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
                    kubectl apply -k .
                    kubectl rollout status deployment/django -n production
                """
            }
        }
        
        stage('Run Migrations') {
            steps {
                sh """
                    kubectl apply -f k8s/jobs/django-migrate-job.yaml
                    kubectl wait --for=condition=complete --timeout=300s job/django-migrate
                """
            }
        }
        
        stage('Smoke Tests') {
            steps {
                sh '''
                    sleep 30
                    curl -f https://safarichap.com/health/ || exit 1
                '''
            }
        }
    }
    
    post {
        success {
            slackSend(
                channel: env.SLACK_CHANNEL,
                color: 'good',
                message: "✅ Deployment successful: ${env.JOB_NAME} #${env.BUILD_NUMBER} - ${env.IMAGE_TAG}"
            )
        }
        failure {
            slackSend(
                channel: env.SLACK_CHANNEL,
                color: 'danger',
                message: "❌ Deployment failed: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
            )
        }
        always {
            cleanWs()
        }
    }
}